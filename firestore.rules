/**
 * @fileOverview Firestore Security Rules for PoolCare Pro.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full control over their own data (clients, pools, schedules, visits, payments, and reports). Global products are publicly readable but not writable except for admin users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles and settings, accessible only to the owning user.
 * - /users/{userId}/clients/{clientId}: Stores client information, accessible only to the owning user.
 * - /users/{userId}/clients/{clientId}/pools/{poolId}: Stores pool details, accessible only to the owning user.
 * - /products/{productId}: Stores a global catalog of products, publicly readable but writable only by admins (not yet implemented in this ruleset).
 * - /users/{userId}/clients/{clientId}/schedules/{scheduleId}: Stores schedule entries, accessible only to the owning user.
 * - /users/{userId}/clients/{clientId}/visits/{visitId}: Stores visit logs, accessible only to the owning user.
 * - /users/{userId}/clients/{clientId}/payments/{paymentId}: Stores payment information, accessible only to the owning user.
 * - /users/{userId}/reports/{reportId}: Stores generated reports, accessible only to the owning user.
 *
 * Key Security Decisions:
 * - User data is strictly segregated; one user cannot access another user's data.
 * - Listing of user documents is disallowed for privacy. Only the authenticated user can get their own profile.
 * - Product data is publicly readable, which is suitable for a product catalog. Write access to products is currently open (TODO: restrict to admins).
 *
 * Denormalization for Authorization:
 *  - All collections under /users/{userId} inherently belong to that user. No additional denormalization is required.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles and settings.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their profile if the ID matches their auth UID.
     * @allow (update) Authenticated user can update their own profile.
     * @allow (delete) Authenticated user can delete their own profile.
     * @deny (get) Another user tries to read this user's profile.
     * @deny (create) Another user tries to create a profile with this user's ID.
     * @deny (update) Another user tries to update this user's profile.
     * @deny (delete) Another user tries to delete this user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; //Immutable ID
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to client data for a specific user.
     * @path /users/{userId}/clients/{clientId}
     * @allow (get) Authenticated user can read their own client data.
     * @allow (create) Authenticated user can create client data under their user ID.
     * @allow (update) Authenticated user can update their own client data.
     * @allow (delete) Authenticated user can delete their own client data.
     * @deny (get) Another user tries to read this client data.
     * @deny (create) Another user tries to create client data under another user's ID.
     * @deny (update) Another user tries to update this client data.
     * @deny (delete) Another user tries to delete this client data.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clients/{clientId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to pool data for a specific client of a user.
     * @path /users/{userId}/clients/{clientId}/pools/{poolId}
     * @allow (get) Authenticated user can read their own pool data.
     * @allow (create) Authenticated user can create pool data under their user and client ID.
     * @allow (update) Authenticated user can update their own pool data.
     * @allow (delete) Authenticated user can delete their own pool data.
     * @deny (get) Another user tries to read this pool data.
     * @deny (create) Another user tries to create pool data under another user's ID.
     * @deny (update) Another user tries to update this pool data.
     * @deny (delete) Another user tries to delete this pool data.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clients/{clientId}/pools/{poolId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to the global product catalog.
     * @path /products/{productId}
     * @allow (get) Any user can read product data.
     * @allow (list) Any user can list products.
     * @deny (create) Only admins can create products (TODO: Implement admin check).
     * @deny (update) Only admins can update products (TODO: Implement admin check).
     * @deny (delete) Only admins can delete products (TODO: Implement admin check).
     * @principle Public read, restricted write.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;

      allow create: if false; // TODO: Add admin validation once the schema is updated with an admin field.
      allow update: if false; // TODO: Add admin validation once the schema is updated with an admin field.
      allow delete: if false; // TODO: Add admin validation once the schema is updated with an admin field.
    }
    
    // This rule enables the collectionGroup query for 'schedules' in the app.
    // It allows a user to list all schedules that belong to them across all their clients.
    match /users/{userId}/clients/{clientId}/schedules/{scheduleId} {
      // The user must be the owner of the parent user document.
      // The document being read/written must have a 'userId' field that matches the authenticated user's UID.
      allow read, write: if request.auth.uid == userId && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Controls access to visit data for a specific client of a user.
     * @path /users/{userId}/clients/{clientId}/visits/{visitId}
     * @allow (get) Authenticated user can read their own visit data.
     * @allow (create) Authenticated user can create visit data under their user and client ID.
     * @allow (update) Authenticated user can update their own visit data.
     * @allow (delete) Authenticated user can delete their own visit data.
     * @deny (get) Another user tries to read this visit data.
     * @deny (create) Another user tries to create visit data under another user's ID.
     * @deny (update) Another user tries to update this visit data.
     * @deny (delete) Another user tries to delete this visit data.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clients/{clientId}/visits/{visitId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to payment data for a specific client of a user.
     * @path /users/{userId}/clients/{clientId}/payments/{paymentId}
     * @allow (get) Authenticated user can read their own payment data.
     * @allow (create) Authenticated user can create payment data under their user and client ID.
     * @allow (update) Authenticated user can update their own payment data.
     * @allow (delete) Authenticated user can delete their own payment data.
     * @deny (get) Another user tries to read this payment data.
     * @deny (create) Another user tries to create payment data under another user's ID.
     * @deny (update) Another user tries to update this payment data.
     * @deny (delete) Another user tries to delete this payment data.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/clients/{clientId}/payments/{paymentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to report data for a specific user.
     * @path /users/{userId}/reports/{reportId}
     * @allow (get) Authenticated user can read their own report data.
     * @allow (create) Authenticated user can create report data under their user ID.
     * @allow (update) Authenticated user can update their own report data.
     * @allow (delete) Authenticated user can delete their own report data.
     * @deny (get) Another user tries to read this report data.
     * @deny (create) Another user tries to create report data under another user's ID.
     * @deny (update) Another user tries to update this report data.
     * @deny (delete) Another user tries to delete this report data.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}
